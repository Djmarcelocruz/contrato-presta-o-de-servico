<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor de Compras - 7 Moradores</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #25d366; --dark: #202124; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background: #f8f9fa; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: var(--dark); color: white; padding: 15px; border-radius: 0 0 15px 15px; }
        .names-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 90%; }
        .person-btn { border: 1px solid #ddd; padding: 6px 12px; margin: 3px; cursor: pointer; border-radius: 15px; font-size: 12px; display: inline-block; background: #fff; }
        .person-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .whatsapp-btn { background: var(--success); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .btn-blue { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <h3 style="margin:0 0 10px 0">üí∞ Total Individual</h3>
        <div id="final-costs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 14px;"></div>
        <button class="whatsapp-btn" onclick="shareWhatsApp()">üì≤ Enviar WhatsApp</button>
    </div>

    <div id="setup-card" class="card">
        <h3>üë• Configurar Nomes (7 Moradores)</h3>
        <div class="names-input-grid" id="inputs-container"></div>
        <button class="btn-blue" onclick="saveNames()">‚úÖ Salvar e Come√ßar</button>
    </div>

    <div id="main-content" class="hidden">
        <div class="card">
            <button onclick="editNames()" style="float:right; font-size:10px;">‚öôÔ∏è Mudar Nomes</button>
            <h3>1. Ler Nota Fiscal</h3>
            <input type="file" accept="image/*" id="file-input" style="width:100%">
            <div id="status" style="margin-top:10px; color:var(--primary); font-weight:bold;"></div>
        </div>

        <div id="items-container" class="card">
            <p>Aguardando leitura da nota...</p>
        </div>
    </div>

    <script>
        let moradores = JSON.parse(localStorage.getItem('moradores')) || [];
        let items = [];

        function init() {
            const container = document.getElementById('inputs-container');
            container.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const nome = moradores[i] || `Morador ${i+1}`;
                container.innerHTML += `<input type="text" id="name-input-${i}" value="${nome}" placeholder="Nome ${i+1}">`;
            }
            if (moradores.length === 7) showMain();
        }

        function saveNames() {
            moradores = [];
            for (let i = 0; i < 7; i++) {
                moradores.push(document.getElementById(`name-input-${i}`).value || `Morador ${i+1}`);
            }
            localStorage.setItem('moradores', JSON.stringify(moradores));
            showMain();
        }

        function showMain() {
            document.getElementById('setup-card').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            calculate();
        }

        function editNames() {
            document.getElementById('setup-card').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }

        // L√ìGICA DE OCR E C√ÅLCULO
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('status').innerText = "‚è≥ Lendo nota...";
            const worker = await Tesseract.createWorker('por');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            document.getElementById('status').innerText = "‚úÖ Conclu√≠do!";
            processText(text);
        });

        function processText(text) {
            const lines = text.split('\n');
            items = [];
            lines.forEach(line => {
                const priceMatch = line.match(/(\d+[.,]\d{2})/);
                if (priceMatch) {
                    const preco = parseFloat(priceMatch[1].replace(',', '.'));
                    if (preco > 0.40 && preco < 1000) {
                        let nome = line.replace(priceMatch[0], '').replace(/[0-9]/g, '').trim().substring(0,20);
                        items.push({ nome: nome || "PRODUTO", preco, pagadores: [0,1,2,3,4,5,6] });
                    }
                }
            });
            renderItems();
            calculate();
        }

        function togglePerson(itemIdx, pIdx) {
            const item = items[itemIdx];
            const pos = item.pagadores.indexOf(pIdx);
            if (pos > -1) item.pagadores.splice(pos, 1);
            else item.pagadores.push(pIdx);
            renderItems();
            calculate();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = items.map((item, i) => `
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <strong>${item.nome}</strong> - R$ ${item.preco.toFixed(2)}<br>
                    ${moradores.map((n, pIdx) => `
                        <div class="person-btn ${item.pagadores.includes(pIdx) ? 'active' : ''}" 
                             onclick="togglePerson(${i}, ${pIdx})">${n}</div>
                    `).join('')}
                </div>
            `).join('');
        }

        function calculate() {
            let totals = new Array(7).fill(0);
            items.forEach(item => {
                if (item.pagadores.length > 0) {
                    const share = item.preco / item.pagadores.length;
                    item.pagadores.forEach(pIdx => totals[pIdx] += share);
                }
            });
            document.getElementById('final-costs').innerHTML = moradores.map((n, i) => 
                `<div>${n}: <strong>R$ ${totals[i].toFixed(2)}</strong></div>`
            ).join('');
        }

        function shareWhatsApp() {
            let msg = "*üìä RESUMO DA COMPRA*\n\n";
            moradores.forEach((n, i) => {
                const val = parseFloat(document.getElementById('final-costs').children[i].querySelector('strong').innerText.replace('R$ ', ''));
                if (val > 0) msg += `üë§ *${n}:* R$ ${val.toFixed(2)}\n`;
            });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(msg));
        }

        init();
    </script>
</body>
</html>
