<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa Casa - Divisor de Compras</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #1a73e8; --success: #25d366; --dark: #202124; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #f8f9fa; }
        .setup-card, .summary-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .summary-card { background: var(--dark); color: white; position: sticky; top: 10px; z-index: 100; }
        .names-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .item-row { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .person-btn { border: 1px solid #ddd; padding: 8px 12px; margin: 4px; cursor: pointer; border-radius: 20px; font-size: 12px; display: inline-block; transition: 0.2s; }
        .person-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        #reader { width: 100%; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="summary-card">
        <h3 style="margin:0 0 10px 0">üí∞ Total por Morador</h3>
        <div id="final-costs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;"></div>
        <button onclick="shareWhatsApp()" style="background:var(--success); color:white; border:none; width:100%; padding:10px; border-radius:5px; margin-top:15px; font-weight:bold;">üì≤ Enviar no Grupo</button>
    </div>

    <div id="setup-section" class="setup-card">
        <h3>üè† Configurar Moradores</h3>
        <div class="names-grid" id="names-inputs">
            </div>
        <button class="btn-main" onclick="saveNames()">Salvar Nomes e Come√ßar</button>
    </div>

    <div id="main-section" style="display:none">
        <div class="setup-card">
            <h3>üì∑ Escanear Nota</h3>
            <button class="btn-main" style="background:#555" onclick="startQR()">Usar Scanner de QR Code</button>
            <div id="reader"></div>
            <p style="text-align:center">OU</p>
            <input type="file" accept="image/*" id="file-input" style="width:100%">
            <div id="status" style="color:var(--primary); font-weight:bold; margin-top:10px"></div>
        </div>

        <div id="items-container"></div>
    </div>

    <script>
        let moradores = JSON.parse(localStorage.getItem('moradores')) || ["Pessoa 1", "Pessoa 2", "Pessoa 3", "Pessoa 4", "Pessoa 5", "Pessoa 6", "Pessoa 7"];
        let items = [];

        // Inicializa inputs de nomes
        const inputsDiv = document.getElementById('names-inputs');
        moradores.forEach((n, i) => {
            inputsDiv.innerHTML += `<input type="text" id="name-${i}" value="${n}" placeholder="Nome ${i+1}">`;
        });

        function saveNames() {
            for(let i=0; i<7; i++) moradores[i] = document.getElementById(`name-${i}`).value || `Pessoa ${i+1}`;
            localStorage.setItem('moradores', JSON.stringify(moradores));
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            calculate();
        }

        // Se j√° tiver nomes salvos, pula o setup
        if(localStorage.getItem('moradores')) saveNames();

        // L√≥gica de Leitura de Imagem (OCR)
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const status = document.getElementById('status');
            status.innerText = "üîç Lendo produtos da foto...";
            
            const worker = await Tesseract.createWorker('por');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            
            status.innerText = "‚úÖ Nota lida!";
            processText(text);
        });

        function processText(text) {
            const lines = text.split('\n');
            items = [];
            lines.forEach(line => {
                const priceMatch = line.match(/(\d+[.,]\d{2})/);
                if (priceMatch) {
                    const preco = parseFloat(priceMatch[1].replace(',', '.'));
                    if (preco > 0.50 && preco < 1000) {
                        items.push({ 
                            nome: line.replace(priceMatch[0], '').replace(/[0-9]/g, '').trim().substring(0,20) || "PRODUTO",
                            preco: preco, 
                            pagadores: [0,1,2,3,4,5,6] 
                        });
                    }
                }
            });
            renderItems();
            calculate();
        }

        function startQR() {
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                window.open(text, '_blank'); // Abre o site da SEFAZ
                html5QrCode.stop();
            });
        }

        function togglePerson(itemIdx, pIdx) {
            const item = items[itemIdx];
            const idx = item.pagadores.indexOf(pIdx);
            if (idx > -1) item.pagadores.splice(idx, 1);
            else item.pagadores.push(pIdx);
            renderItems();
            calculate();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = items.map((item, i) => `
                <div class="item-row">
                    <strong>${item.nome} - R$ ${item.preco.toFixed(2)}</strong><br>
                    ${moradores.map((name, pIdx) => `
                        <div class="person-btn ${item.pagadores.includes(pIdx) ? 'active' : ''}" 
                             onclick="togglePerson(${i}, ${pIdx})">${name}</div>
                    `).join('')}
                </div>
            `).join('');
        }

        function calculate() {
            let totals = new Array(7).fill(0);
            items.forEach(item => {
                if (item.pagadores.length > 0) {
                    const share = item.preco / item.pagadores.length;
                    item.pagadores.forEach(pIdx => totals[pIdx] += share);
                }
            });
            document.getElementById('final-costs').innerHTML = moradores.map((n, i) => `
                <div>${n}: <strong>R$ ${totals[i].toFixed(2)}</strong></div>
            `).join('');
        }

        function shareWhatsApp() {
            let msg = "*üìù DIVIS√ÉO DA COMPRA*\n\n";
            moradores.forEach((n, i) => {
                const val = document.getElementById('final-costs').children[i].innerText;
                msg += `‚úÖ *${val}*\n`;
            });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(msg));
        }
    </script>
</body>
</html>
