<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor de Compras Coletivo</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #25d366; --bg: #f1f3f4; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: #333; }
        
        .sticky-header { position: sticky; top: 0; z-index: 100; background: #202124; color: white; padding: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .names-filter { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .filter-item { background: #eee; padding: 8px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 5px; }

        .item-row { border-bottom: 1px solid #eee; padding: 12px 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        .person-btn { border: 1px solid #ddd; padding: 6px 12px; margin: 3px; cursor: pointer; border-radius: 15px; font-size: 12px; display: inline-block; background: #fff; }
        .person-btn.active { background: var(--success); color: white; border-color: var(--success); }
        
        .btn-action { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        .whatsapp-btn { background: var(--success); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #status { font-size: 12px; color: var(--primary); margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <h3 style="margin:0 0 10px 0">ðŸ’° Total Individual</h3>
        <div id="final-costs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 14px;">
            </div>
        <button class="whatsapp-btn" onclick="shareWhatsApp()">ðŸ“² Enviar no WhatsApp</button>
    </div>

    <div class="card">
        <h3>1. Quem participa desta compra?</h3>
        <div class="names-filter" id="presence-list"></div>
    </div>

    <div class="card">
        <h3>2. Escanear Nota</h3>
        <input type="file" accept="image/*" id="file-input" class="btn-action" style="background: #5f6368">
        <div id="status"></div>
    </div>

    <div class="card">
        <h3>3. Itens e DivisÃ£o</h3>
        <div id="items-container">Aguardando leitura da nota...</div>
    </div>

    <script>
        // LISTA DE MORADORES - VocÃª pode mudar os nomes aqui
        const moradoresFixo = ["Morador 1", "Morador 2", "Morador 3", "Morador 4", "Morador 5", "Morador 6", "Morador 7"];
        let ativosIdx = [0, 1, 2, 3, 4, 5, 6]; 
        let items = [];

        // Inicializa a lista de presenÃ§a
        function initPresence() {
            const list = document.getElementById('presence-list');
            list.innerHTML = moradoresFixo.map((nome, i) => `
                <div class="filter-item">
                    <input type="checkbox" checked onchange="updateAtivos(${i})" id="chk-${i}">
                    <label for="chk-${i}">${nome}</label>
                </div>
            `).join('');
        }

        function updateAtivos(idx) {
            const isChecked = document.getElementById(`chk-${idx}`).checked;
            if (isChecked) {
                if (!ativosIdx.includes(idx)) ativosIdx.push(idx);
            } else {
                ativosIdx = ativosIdx.filter(id => id !== idx);
            }
            // Se mudar os ativos, reseta a divisÃ£o dos itens para os novos ativos
            items.forEach(item => item.pagadores = [...ativosIdx]);
            renderItems();
            calculate();
        }

        // Leitura da Imagem
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('status').innerText = "â³ Processando imagem... Aguarde.";

            const worker = await Tesseract.createWorker('por');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();

            document.getElementById('status').innerText = "âœ… Nota carregada!";
            processText(text);
        });

        function processText(text) {
            const lines = text.split('\n');
            items = [];
            lines.forEach(line => {
                const priceMatch = line.match(/(\d+[.,]\d{2})/);
                if (priceMatch) {
                    const preco = parseFloat(priceMatch[1].replace(',', '.'));
                    if (preco > 0.40 && preco < 1000) {
                        let nome = line.replace(priceMatch[0], '').replace(/[0-9]/g, '').trim().substring(0,20);
                        items.push({ nome: nome || "PRODUTO", preco, pagadores: [...ativosIdx] });
                    }
                }
            });
            renderItems();
            calculate();
        }

        function togglePerson(itemIdx, pIdx) {
            const item = items[itemIdx];
            const pos = item.pagadores.indexOf(pIdx);
            if (pos > -1) item.pagadores.splice(pos, 1);
            else item.pagadores.push(pIdx);
            renderItems();
            calculate();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            if (items.length === 0) { container.innerHTML = "Nenhum item detectado."; return; }
            
            container.innerHTML = items.map((item, i) => `
                <div class="item-row">
                    <div class="item-header">
                        <strong>${item.nome}</strong>
                        <span>R$ ${item.preco.toFixed(2)}</span>
                    </div>
                    <div>
                        ${ativosIdx.map(pIdx => `
                            <div class="person-btn ${item.pagadores.includes(pIdx) ? 'active' : ''}" 
                                 onclick="togglePerson(${i}, ${pIdx})">${moradoresFixo[pIdx]}</div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function calculate() {
            let totals = new Array(7).fill(0);
            items.forEach(item => {
                if (item.pagadores.length > 0) {
                    const share = item.preco / item.pagadores.length;
                    item.pagadores.forEach(pIdx => totals[pIdx] += share);
                }
            });

            document.getElementById('final-costs').innerHTML = moradoresFixo.map((nome, i) => {
                if (!ativosIdx.includes(i)) return '';
                return `<div>${nome}: <strong>R$ ${totals[i].toFixed(2)}</strong></div>`;
            }).join('');
        }

        function shareWhatsApp() {
            let msg = "*ðŸ“Š DIVISÃƒO DE COMPRA*\n\n";
            ativosIdx.forEach(idx => {
                const valStr = document.getElementById('final-costs').innerText;
                const match = valStr.match(new RegExp(moradoresFixo[idx] + ": R\\$ (\\d+\\.\\d{2})"));
                if (match) msg += `ðŸ‘¤ *${moradoresFixo[idx]}:* R$ ${match[1]}\n`;
            });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(msg));
        }

        initPresence();
    </script>
</body>
</html>
