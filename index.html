<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor Nossa Casa - 7 Pessoas</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #25d366; --danger: #d93025; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #f1f3f4; }
        .summary-card { background: #202124; color: white; padding: 20px; border-radius: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-top: 15px; }
        .item-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .person-btn { border: 1px solid #ddd; padding: 8px 12px; margin: 3px; cursor: pointer; border-radius: 20px; font-size: 12px; display: inline-block; background: #fff; }
        .person-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .btn-fast { font-size: 10px; padding: 4px 8px; margin-left: 5px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background: #eee; }
        .whatsapp-btn { background: var(--success); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="summary-card">
        <h3 style="margin:0 0 10px 0">ðŸ’° Total por Morador</h3>
        <div id="final-costs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 14px;"></div>
        <button class="whatsapp-btn" onclick="shareWhatsApp()">ðŸ“² Enviar Resumo no WhatsApp</button>
    </div>

    <div class="card">
        <h3>1. Foto da Nota Fiscal</h3>
        <input type="file" accept="image/*" id="file-input" style="width:100%">
        <div id="status" style="margin-top:10px; color: var(--primary); font-weight:bold;"></div>
    </div>

    <div id="items-container" class="card">
        <p style="color:#666">Os itens aparecerÃ£o aqui apÃ³s a leitura...</p>
    </div>

    <script>
        // VocÃª pode trocar os nomes aqui uma Ãºnica vez
        const moradores = ["Morador 1", "Morador 2", "Morador 3", "Morador 4", "Morador 5", "Morador 6", "Morador 7"];
        let items = [];

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.innerText = "â³ Lendo nota... Aguarde.";

            const worker = await Tesseract.createWorker('por');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();

            status.innerText = "âœ… Leitura concluÃ­da!";
            processText(text);
        });

        function processText(text) {
            const lines = text.split('\n');
            items = [];
            lines.forEach(line => {
                const priceMatch = line.match(/(\d+[.,]\d{2})/);
                if (priceMatch) {
                    const preco = parseFloat(priceMatch[1].replace(',', '.'));
                    if (preco > 0.30 && preco < 1000) {
                        let nome = line.replace(priceMatch[0], '').replace(/[0-9]/g, '').trim().substring(0,20);
                        items.push({ nome: nome || "PRODUTO", preco, pagadores: [0,1,2,3,4,5,6] });
                    }
                }
            });
            renderItems();
            calculate();
        }

        function togglePerson(itemIdx, pIdx) {
            const item = items[itemIdx];
            const index = item.pagadores.indexOf(pIdx);
            if (index > -1) item.pagadores.splice(index, 1);
            else item.pagadores.push(pIdx);
            renderItems();
            calculate();
        }

        function setAll(itemIdx, active) {
            items[itemIdx].pagadores = active ? [0,1,2,3,4,5,6] : [];
            renderItems();
            calculate();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = items.map((item, i) => `
                <div class="item-row">
                    <div>
                        <strong>${item.nome}</strong> - R$ ${item.preco.toFixed(2)}
                        <button class="btn-fast" onclick="setAll(${i}, true)">Todos</button>
                        <button class="btn-fast" onclick="setAll(${i}, false)">NinguÃ©m</button>
                    </div>
                    <div style="margin-top:8px">
                        ${moradores.map((n, pIdx) => `
                            <div class="person-btn ${item.pagadores.includes(pIdx) ? 'active' : ''}" 
                                 onclick="togglePerson(${i}, ${pIdx})">${n}</div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function calculate() {
            let totals = new Array(7).fill(0);
            items.forEach(item => {
                if (item.pagadores.length > 0) {
                    const share = item.preco / item.pagadores.length;
                    item.pagadores.forEach(pIdx => totals[pIdx] += share);
                }
            });
            document.getElementById('final-costs').innerHTML = moradores.map((n, i) => 
                `<div>${n}: <strong>R$ ${totals[i].toFixed(2)}</strong></div>`
            ).join('');
        }

        function shareWhatsApp() {
            let msg = "*ðŸ“Š RESUMO DA COMPRA COLETIVA*\n\n";
            let totalGeral = 0;
            moradores.forEach((n, i) => {
                const val = parseFloat(document.getElementById('final-costs').children[i].querySelector('strong').innerText.replace('R$ ', ''));
                if (val > 0) {
                    msg += `ðŸ‘¤ *${n}:* R$ ${val.toFixed(2)}\n`;
                    totalGeral += val;
                }
            });
            msg += `\nðŸ’° *Total da Nota:* R$ ${totalGeral.toFixed(2)}`;
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(msg));
        }
    </script>
</body>
</html>
